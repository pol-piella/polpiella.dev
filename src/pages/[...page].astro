---
import BaseLayout from '../components/BaseLayout'
import BlogPreview from '../components/BlogPreview'
import Paginator from '../components/Paginator'

export async function getStaticPaths({ rss, paginate }) {
  const posts = await Astro.glob('./*.md')
  const sortedPosts = posts.sort(
    (a, b) =>
      new Date(b.frontmatter.pubDate).valueOf() -
      new Date(a.frontmatter.pubDate).valueOf()
  )

  const uniqBy = (arr, predicate) => {
    const cb = typeof predicate === 'function' ? predicate : (o) => o[predicate]

    return [
      ...arr
        .reduce((map, item) => {
          const key = item === null || item === undefined ? item : cb(item)

          map.has(key) || map.set(key, item)

          return map
        }, new Map())
        .values(),
    ]
  }

  const categories = uniqBy(
    posts.flatMap((post) => post.frontmatter.tags),
    'slug'
  )

  return paginate(sortedPosts, { pageSize: 5, props: { categories } })
}

const { page, categories } = Astro.props
const fullImageURL = `https://www.polpiella.dev/api/thumbnail?title=${encodeURI(
  'polpiella.dev'
)}`
---

<BaseLayout
  title='polpielladev ðŸ“± | A blog about software engineering and app development'
  description='A blog where I talk about software development topics in languages like Swift, Javascript and using frameworks such as Next.js, React, Combine and many more!'
  imageURL={fullImageURL}>
  <div class='px-3 mx-auto my-0 max-w-3xl flex flex-col gap-7'>
    <section
      class='flex flex-col gap-5 items-center text-center md:flex-row md:text-left'>
      <img class='object-cover m-0 w-20 h-auto' src='/assets/profile.png' />
      <div class='prose dark:prose-invert grid content-center'>
        <h2 class='m-0'>
          iOS Dev blog by <a
            class='font-bold underline decoration-amber-500 decoration-wavy hover:text-amber-700 dark:hover:text-amber-300'
            target='_blank'
            rel='noopener noreferrer'
            href='https://twitter.com/polpielladev'
            >Pol Piella
          </a>
        </h2>
        <p class='m-0'>iOS developer at <b>BBC iPlayer</b></p>
        <p class='m-0'>
          I love to talk about <b>iOS development</b> and my career as <b
            >a software engineer
          </b>.
        </p>
      </div>
    </section>
    {page.currentPage == 1 && (
      <section class="prose dark:prose-invert prose-a:no-underline dark:prose-a:text-gray-200 prose-a:text-gray-700">
        <h1 class="mb-3 text-2xl font-bold">Browse by topic</h1>
        <div class="flex flex-wrap gap-3">
          {categories.map((category) => (
            <a
              href={`/category/${category.slug}`}
              class="rounded bg-gray-300 px-2  transition-colors hover:bg-slate-300 dark:bg-gray-700 dark:hover:bg-slate-800">
              {category.name}
            </a>
          ))}
        </div>
      </section>
    )}
    <Paginator previousURL={page.url.prev} nextURL={page.url.next} />
    <section class='flex flex-col gap-10'>
      {page.data.map((post) => <BlogPreview post={post} />)}
    </section>
  </div>
</BaseLayout>
