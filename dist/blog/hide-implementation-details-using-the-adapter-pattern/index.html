<!DOCTYPE html><html><head><title>Hiding implementation details using the adapter pattern in Swift</title><meta name="twitter:title" content="Hiding implementation details using the adapter pattern in Swift"><meta name="twitter:description" content="How to hide implementation details using the adapter pattern and decoupling multiple layers of an application, making it easy to test and adapt."><meta name="description" content="How to hide implementation details using the adapter pattern and decoupling multiple layers of an application, making it easy to test and adapt."><meta name="twitter:site" content="@polcodes"><meta name="twitter:card" content="summary_large_image"><link rel="stylesheet" href="/_astro/common-DTqaC.css" type="text/css"><link rel="stylesheet" href="/style/global.css"><link rel="stylesheet" href="/style/blog-detail.css"></head><body><header class="astro-zvkshqHn"><a class="animated astro-zvkshqHn" href="/"><img src="/assets/logo.svg" class="astro-zvkshqHn"></a></header><div class="container astro-ocCYdhnH"><article class="content astro-ocCYdhnH"><header class="astro-ocCYdhnH"><h1 class="astro-ocCYdhnH">Hiding implementation details using the adapter pattern in Swift</h1><div class="tags astro-OIpm9CS9"><div class="tag astro-OIpm9CS9">Architecture</div><div class="tag astro-OIpm9CS9">Swift</div></div><div class="metadata bottom-spaced astro-FzCPOh4H"><p class="astro-FzCPOh4H">Sun Aug 01 2021</p><p class="astro-FzCPOh4H">Â·</p><p class="astro-FzCPOh4H">ðŸ“– 6 minutes</p><div class="metadata astro-FzCPOh4H"><p class="astro-FzCPOh4H">Â·</p><a target="_blank" rel="noopener noreferrer" href="https://github.com/pol-piella/polpiella.dev/edit/main/_posts/undefined.md" class="astro-FzCPOh4H"><b class="astro-FzCPOh4H">Found a mistake? Edit on Github!</b></a></div></div></header><hr class="astro-ocCYdhnH"><p>Recently, I have been working on a project where I have had to implement a mechanism to load data from an API (<a href="https://documenter.getpostman.com/view/2025350/RWaEzAiG?version=latest">SpaceX</a>) while also providing a caching mechanism to allow users to have a good offline experience and to save the BE from unnecessary requests when data is available. This was an interesting project as there were a few challenges that needed to be tackled, such as cache invalidation, where to store the cache data, etc.</p><p>To do this as modularily as possible, I wanted to provide a clear separation between frameworks, use cases and the presentation layer. I also wanted the implementation to be as flexible as it possibly could, making it very easy to replace any frameworks or 3rd party libraries I used (e.g. Realm, Core Data, Alamofire, etc.). This way any change in requirements would be guarded by SOLID principles and would be easy to implement, as we will see later on.</p><h2 id="the-adapter-pattern"><a href="#the-adapter-pattern" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>The adapter pattern</h2><p>To achieve this goal, I decided to go with the <strong>Adapter</strong> design pattern. As described in the famous <a href="https://www.amazon.co.uk/Design-patterns-elements-reusable-object-oriented/dp/0201633612">Design Patterns</a> book, adapters allow you to compatibilize two incompatible interfaces. In other words, <strong>we can use an adapter layer to sit between our adaptee and our target layers and handles the conversion between incompatible interfaces.</strong></p><p>Let's start by looking at what needs to be converted in our example:</p><ul><li>The API returns a <code>Launch</code> type which needs to conform to <code>Decodable</code> and can be decoded from the body of the server's response. While the easy approach would be to use this in our presentation layer, <strong>this would tightly couple our local and remote implementations</strong>, which is not ideal. This is why we will only use our <code>Launch</code> decodable type in the <code>API</code> module and we will convert it into a <code>LaunchViewModel</code> within the API adapter.</li><li>The cache implementation stores encoded versions of our <code>LaunchViewModel</code> type as <code>Data</code> and we also need a way to convert this into a <code>LaunchViewModel</code> type that our presentation layer can understand. This will be the cache adapter's responsibility.</li></ul><p>In Swift, the nicest way of bridging this interface mismatch is by creating a protocol that our concrete implementations can conform to and then make our target class depend solely on any number of types conforming to this abstraction, which satisfies the presentation layer's requirements.</p><pre class=" language-swift"><code class="language-swift"><span class="token keyword">protocol</span> <span class="token class-name">FetchService</span> <span class="token punctuation">{</span>
    <span class="token keyword">func</span> <span class="token function-definition function">fetchLaunches</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> completion<span class="token punctuation">:</span> <span class="token attribute atrule">@escaping</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token class-name">LaunchViewModel</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Void</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="api-adapter"><a href="#api-adapter" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>API Adapter</h3><p>Let's now look at what the API adapter would look like. Let's assume we have a class that takes care of fetching the data (launches in this example) for us and returns the <code>Launch</code> remote model. We can then create an adapter class that conforms to the <code>FetchService</code> protocol we created above and implement the method <code>fetchLaunches</code>, where we will call the API we inject and then map the response from <code>Result&lt;[Launch], Error&gt;</code> over to <code>Result&lt;[LaunchViewModel], Error&gt;</code> like so:</p><pre class=" language-swift"><code class="language-swift"><span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">SpaceXAPIAdapter</span><span class="token punctuation">:</span> <span class="token class-name">FetchService</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> api<span class="token punctuation">:</span> <span class="token class-name">SpaceXAPI</span>

    <span class="token keyword">init</span><span class="token punctuation">(</span>api<span class="token punctuation">:</span> <span class="token class-name">SpaceXAPI</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>api <span class="token operator">=</span> api
    <span class="token punctuation">}</span>

    <span class="token keyword">func</span> <span class="token function-definition function">fetchLaunches</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> completion<span class="token punctuation">:</span> <span class="token attribute atrule">@escaping</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token class-name">LaunchViewModel</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        api<span class="token punctuation">.</span>fetchLaunches <span class="token punctuation">{</span> result <span class="token keyword">in</span>
            <span class="token keyword">switch</span> result <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token keyword">let</span> <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>launches<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">let</span> launchViewModels <span class="token operator">=</span> launches
                    <span class="token punctuation">.</span>map <span class="token punctuation">{</span> <span class="token class-name">LaunchViewModel</span><span class="token punctuation">(</span>from<span class="token punctuation">:</span> <span class="token short-argument">$0</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
                <span class="token function">completion</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>launchViewModels<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">case</span> <span class="token keyword">let</span> <span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token function">completion</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>We could even go one step further and create a <code>Mapper</code> class with a single static method that performs this transform but, for the purpose of this article, the functionality will stay within the adapter.</p><h3 id="cache-adapter"><a href="#cache-adapter" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Cache Adapter</h3><p>Once the API adapter was implemented, the next logical step was to try and do the same for the caching mechanism. This is very similar to the API adapter with the difference that our cache store (which could be implemented in any flavour we like and have any policies we want without our adapter being aware) returns <code>Data</code> instead of <code>Launch</code> remote models.</p><p>The adapters responsibility on the method conformance will be to decode this data into an array of <code>LaunchViewModel</code>s using a <code>JSONDecoder</code>.</p><pre class=" language-swift"><code class="language-swift"><span class="token keyword">struct</span> <span class="token class-name">SpaceXCacheAdapter</span><span class="token punctuation">:</span> <span class="token class-name">FetchService</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> store<span class="token punctuation">:</span> <span class="token class-name">SpaceXStore</span>
    <span class="token keyword">let</span> decoder<span class="token punctuation">:</span> <span class="token class-name">JSONDecoder</span>

    <span class="token keyword">init</span><span class="token punctuation">(</span>store<span class="token punctuation">:</span> <span class="token class-name">SpaceXStore</span><span class="token punctuation">,</span> decoder<span class="token punctuation">:</span> <span class="token class-name">JSONDecoder</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>store <span class="token operator">=</span> store
        <span class="token keyword">self</span><span class="token punctuation">.</span>decoder <span class="token operator">=</span> decoder
    <span class="token punctuation">}</span>

    <span class="token keyword">func</span> <span class="token function-definition function">fetchLaunches</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> completion<span class="token punctuation">:</span> <span class="token attribute atrule">@escaping</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token class-name">LaunchViewModel</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        store<span class="token punctuation">.</span>fetchLaunches <span class="token punctuation">{</span> result <span class="token keyword">in</span>
            <span class="token keyword">switch</span> result <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token keyword">let</span> <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    <span class="token function">completion</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>decoder<span class="token punctuation">.</span><span class="token function">decoded</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token class-name">LaunchViewModel</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token keyword">let</span> error <span class="token punctuation">{</span>
                    <span class="token function">completion</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token keyword">case</span> <span class="token keyword">let</span> <span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token function">completion</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>This now allow us to change our <code>SpaceXStore</code> implementation to anything we like and use any 1st of 3rd party libraries without having to change our adapters.</p><h3 id="the-service"><a href="#the-service" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>The Service</h3><p>The last piece of our puzzle is the actual service class that will get called by the presentation layer. Let's create it providing a primary source of data and a backup incase the the primary source fails. One might ask now, which one is which? How do we know if the primary source is the cache or the API? The truth is, <strong>it doesn't matter, that is something for the composition root to deal with! To the service, both primary and backup sources look exactly the same</strong>:</p><pre class=" language-swift"><code class="language-swift"><span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">SpaceXService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">let</span> source<span class="token punctuation">:</span> <span class="token class-name">FetchService</span>
    <span class="token keyword">private</span> <span class="token keyword">let</span> backup<span class="token punctuation">:</span> <span class="token class-name">FetchService</span>

    <span class="token keyword">init</span><span class="token punctuation">(</span>source<span class="token punctuation">:</span> <span class="token class-name">FetchService</span><span class="token punctuation">,</span> backup<span class="token punctuation">:</span> <span class="token class-name">FetchService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>source <span class="token operator">=</span> source
        <span class="token keyword">self</span><span class="token punctuation">.</span>backup <span class="token operator">=</span> backup
    <span class="token punctuation">}</span>

    <span class="token keyword">func</span> <span class="token function-definition function">fetchData</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> completion<span class="token punctuation">:</span> <span class="token attribute atrule">@escaping</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token class-name">LaunchViewModel</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        source<span class="token punctuation">.</span>fetchLaunches <span class="token punctuation">{</span> result <span class="token keyword">in</span>
            <span class="token keyword">switch</span> result <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token keyword">let</span> <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>launches<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token function">completion</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>launches<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">case</span> <span class="token punctuation">.</span>failure<span class="token punctuation">:</span>
                    <span class="token function">fetchFromBackup</span><span class="token punctuation">(</span>completion<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function-definition function">fetchFromBackup</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> completion<span class="token punctuation">:</span> <span class="token attribute atrule">@escaping</span> <span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token class-name">LaunchViewModel</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        backup<span class="token punctuation">.</span>fetchLaunches <span class="token punctuation">{</span> result <span class="token keyword">in</span>
            <span class="token keyword">case</span> <span class="token keyword">let</span> <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>launches<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token function">completion</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>launches<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">case</span> <span class="token keyword">let</span> <span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>You might have realised now that, by depending on the adapter abstraction (<code>FetchService</code>), we have completely decoupled the service from our concrete cache and api implementations. Now the service <strong>does not know where it's getting its data from, it only knows that it's getting either an array of <code>LaunchViewModel</code> types or a failure</strong>, without any knowledge of where that data is coming from: it could be an in-memory cache, a Core Data or Realm store or even a graphQL or REST api!</p><p>The adapter implementation of the service now <strong>allows us to change which source is primary and which source is the backup without changing the service</strong>, as we will see in the next section!</p><h2 id="conclusion"><a href="#conclusion" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Conclusion</h2><p>Now that we have all of our adapters in places, we can build our objects at the composition root and pass them through to our presentation layer. For the sake of this example, let's consider a factory method for a <code>HomeViewController</code> where the <code>SpaceXService</code> can be injected:</p><pre class=" language-swift"><code class="language-swift"><span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">makeHomeViewController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">HomeViewController</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cache <span class="token operator">=</span> <span class="token class-name">CacheAdapter</span><span class="token punctuation">(</span>store<span class="token punctuation">:</span> <span class="token class-name">SpaceXStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> api <span class="token operator">=</span> <span class="token class-name">SpaceXAPIAdapter</span><span class="token punctuation">(</span>api<span class="token punctuation">:</span> <span class="token class-name">SpaceXAPI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token class-name">HomeViewController</span><span class="token punctuation">(</span>service<span class="token punctuation">:</span> <span class="token class-name">SpaceXService</span><span class="token punctuation">(</span>source<span class="token punctuation">:</span> cache<span class="token punctuation">,</span> backup<span class="token punctuation">:</span> api<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>In the code snippet above, we are using the cache as our primary source and the api as the backup source, which means that <strong>a request to the API will only be made if there is no cache present or it is not valid</strong>. Now, as we stated in the introduction, the requirements might change in the future and retrieving from cache migth not be what we want. Well, our approach is ready for these kind of changes and it makes it very easy to swap our sources priorities only changing a line in the composition root and leaving the service as it is:</p><pre class=" language-swift"><code class="language-swift"><span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">makeHomeViewController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">HomeViewController</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> <span class="token class-name">HomeViewController</span><span class="token punctuation">(</span>service<span class="token punctuation">:</span> <span class="token class-name">SpaceXService</span><span class="token punctuation">(</span>source<span class="token punctuation">:</span> api<span class="token punctuation">,</span> backup<span class="token punctuation">:</span> cache<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>As can be seen in this example, the adapter pattern is a very useful structural pattern that can help bridge incompatible APIs and provide good separation between layers.</p></article></div><footer class="astro-n31rkg6Y"><div class="social astro-n31rkg6Y"><a class="animated astro-n31rkg6Y" target="_blank" rel="noopener noreferrer" href="https://github.com/pol-piella"><img width="25px" height="25px" src="/assets/github.svg" class="astro-n31rkg6Y"></a><a class="animated astro-n31rkg6Y" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/pol-piella-81b846115/"><img width="25px" height="25px" src="/assets/linkedin.svg" class="astro-n31rkg6Y"></a><a class="animated astro-n31rkg6Y" target="_blank" rel="noopener noreferrer" href="https://twitter.com/polcodes"><img width="25px" height="25px" src="/assets/twitter.svg" class="astro-n31rkg6Y"></a></div></footer></body></html>