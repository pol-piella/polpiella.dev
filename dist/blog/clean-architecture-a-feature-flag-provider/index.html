<!DOCTYPE html><html><head><title>Clean Architecture: A Feature Flag Manager</title><meta name="twitter:title" content="Clean Architecture: A Feature Flag Manager"><meta name="twitter:description" content="Building a Feature Flag Manager system using clean architecture and SOLID design principles."><meta name="description" content="Building a Feature Flag Manager system using clean architecture and SOLID design principles."><meta name="twitter:site" content="@polcodes"><meta name="twitter:card" content="summary_large_image"><link rel="stylesheet" href="/_astro/common-DTqaC.css" type="text/css"><link rel="stylesheet" href="/style/global.css"><link rel="stylesheet" href="/style/blog-detail.css"></head><body><header class="astro-zvkshqHn"><a class="animated astro-zvkshqHn" href="/"><img src="/assets/logo.svg" class="astro-zvkshqHn"></a></header><div class="container astro-ocCYdhnH"><article class="content astro-ocCYdhnH"><header class="astro-ocCYdhnH"><h1 class="astro-ocCYdhnH">Clean Architecture: A Feature Flag Manager</h1><div class="tags astro-OIpm9CS9"><div class="tag astro-OIpm9CS9">Architecture</div><div class="tag astro-OIpm9CS9">Swift</div></div><div class="metadata bottom-spaced astro-FzCPOh4H"><p class="astro-FzCPOh4H">Fri May 14 2021</p><p class="astro-FzCPOh4H">Â·</p><p class="astro-FzCPOh4H">ðŸ“– 7 minutes</p><div class="metadata astro-FzCPOh4H"><p class="astro-FzCPOh4H">Â·</p><a target="_blank" rel="noopener noreferrer" href="https://github.com/pol-piella/polpiella.dev/edit/main/_posts/undefined.md" class="astro-FzCPOh4H"><b class="astro-FzCPOh4H">Found a mistake? Edit on Github!</b></a></div></div></header><hr class="astro-ocCYdhnH"><p>In this blog post we will be looking at how to build a Feature Flag Manager in a clean, scalable and reusable way using clean architecture and <strong>SOLID</strong> design principles.</p><blockquote><p>This blog post was inspired by <a href="https://www.swiftbysundell.com/articles/building-an-enum-based-analytics-system-in-swift/">John Sundell's post on how to make an Analytics service</a> and <a href="https://youtube.com/playlist?list=PLyjgjmI1UzlSWtjAMPOt03L7InkCRlGzb">Essential Developer's playlist on Clean Architecture</a>. I run through how I would go about implementing a Feature Flag Manager system that allows you to turn certain features in your app on or off.</p></blockquote><h2 id="requirements"><a href="#requirements" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Requirements</h2><p>Your company is growing very quickly and, as it does, a bunch of new features are getting tested and rolled out every week. A great part of this process will involve experimentation and A/B testing to make sure that the content and features you are deploying are providing the right value to your users. When you start refining the work ready to be picked up, you get the following requirements:</p><ul><li>Flags will come from multiple providers that your company is currently trialling. Some will come from your in-house experimentation BE service, some others will come from Firebase and others will come from LaunchDarkly.</li><li>Flags will be used in multiple screens throughout a bunch of different features (you can think of these as different modules).</li><li>As you are supporting a wide number of providers, the experimentation values you get back might be very different. Hence, you should make your abstraction very generic and only constrain it to <code>Decodable</code> types.</li><li>The current user must be passed to the providers as they are using attributes to determine which variation to serve when a flag is evaluated. This only needs to be done</li><li>The first flags will be used in the **Settings **and <strong>Feed</strong> modules, which are two of the most worked on screens in our app and we need to test a lot of hypothesis there.</li></ul><h2 id="architecture"><a href="#architecture" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Architecture</h2><p>Now that the requirements are clear, it's time to think about <strong>how</strong> we're going to implement it. The step of going away and drawing a diagram is very important as it sets the foundation for the system you will be working on and allows you to start coding with a very clear idea in mind. I tend to use <code>draw.io</code> to come up with UML diagrams that explain the whole system in as much detail as I can.</p><p>I like to do this step side-by-side with an <code>XCode</code> playground open so that I can, at the same time, put in practice some of the things I have come up with and see what improvements I can make. In the next few sections I will walk you through what the layers for our system will look like.</p><h3 id="providers-and-manager"><a href="#providers-and-manager" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Providers and Manager</h3><p>The first layer that we want to implement will consist of every single provider that holds and retrieves feature flags. These SDKs or BE services can come in many different shapes and forms but the concepts, as we explained in the requirements will be the same. Also, it is worth noting that these SDKs will have a bunch of other methods that we don't really care about, and we want to only expose what is needed by the modules that require the Feature Flag module as a dependency. There are a couple of <strong>SOLID</strong> principles here that we need to keep in mind when designing this layer:</p><ul><li>**Interface Segregation: **What this basically means is that the clients (our Settings and Feed modules) should only depend on what they stricly need. So, from these clients, we only want to make a call to get a variation, so that should literally be our only dependency.</li><li>**Dependency Inversion: **This means that clients should depend on abstractions (e.g. protocols) and not in concretions (e.g. classes). This will be a problem if we depend directly on the providers themselves, as it will break this SOLID principle.</li></ul><p>How can we solve this? <strong>Abstraction!</strong> In Swift, it is particularly easy to abstract types, as we can simply create a protocol and make each of our providers conform to it.</p><pre class=" language-swift"><code class="language-swift"><span class="token keyword">protocol</span> <span class="token class-name">FeatureFlagManager</span> <span class="token punctuation">{</span>
    <span class="token keyword">func</span> <span class="token function-definition function">variation</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">FeatureFlag</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">for</span> flag<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">T</span><span class="token punctuation">.</span><span class="token class-name">T</span>
<span class="token punctuation">}</span>

<span class="token keyword">protocol</span> <span class="token class-name">FeatureFlag</span> <span class="token punctuation">{</span>
    <span class="token keyword">associatedtype</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span>

    <span class="token keyword">var</span> key<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span>
    <span class="token keyword">var</span> defaultValue<span class="token punctuation">:</span> <span class="token class-name">T</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Here we go! We now extend all of our providers to conform to this protocol and, since all of them take different types, we can pass in our own custom <code>FeatureFlag</code> abstract implementation that can then be made concrete on our FE modules.</p><h3 id="user-authentication"><a href="#user-authentication" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>User Authentication</h3><p>As mentioned in our requirements section, and because the providers will return values based on user attributes, we need to pass the <code>User</code> object to the providers. Now, how can we do this? The first instinct would be to add a method to the <code>FeatureFlagManager</code> called <code>setUser</code> that we can then extend each provider with, but that approach would not be the most suitable one? Why? Let's revisit some SOLID principles again:</p><ul><li>**Single Responsibility: **By adding the capability to set the user to the <code>FeatureFlagManager</code> protocol, we have now broken the single responsibility principle. Our class now has two reasons to change/two responsibilities: one to fetch feature flags and one to set the current user.</li><li>**Interface Segregation: **Doing what we just said will also mean that we will break the interface segregation principle that we mentioned above, as now every client that depends on the <code>FeatureFlagManager</code> will have to provide concrete implementation of both <code>setUser</code> and <code>variation</code> even if they only need one of them!</li></ul><p>Thankfully, and as it is usually the case, the answer is very simple. We just need to create another abstraction that our providers can extend:</p><pre class=" language-swift"><code class="language-swift"><span class="token keyword">protocol</span> <span class="token class-name">FeatureFlagUserAuthenticator</span> <span class="token punctuation">{</span>
    <span class="token function">setUser</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> user<span class="token punctuation">:</span> <span class="token class-name">User</span><span class="token operator">?</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> id<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">let</span> countryCode<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">let</span> segments<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="client-implementation"><a href="#client-implementation" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Client Implementation</h3><p>The last requirement we need to implement is to integrate this abstraction as a dependency to all our modules and write concrete implementations of the <code>FeatureFlag</code> abstractions for the variations we want get. For this, I opted to have a struct per module only containing the flags that the module needs. Let's look at Settings as an example:</p><pre class=" language-swift"><code class="language-swift"><span class="token keyword">struct</span> <span class="token class-name">SettingsFeatureFlag</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span><span class="token operator">&gt;</span><span class="token punctuation">:</span> <span class="token class-name">FeatureFlag</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> key<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">let</span> defaultValue<span class="token punctuation">:</span> <span class="token class-name">T</span>

    <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">newProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">SettingsFeatureFlag</span><span class="token operator">&lt;</span><span class="token class-name">Bool</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">SettingsFeatureFlag</span><span class="token operator">&lt;</span><span class="token class-name">Bool</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"new-user-profile"</span></span><span class="token punctuation">,</span>
                                    defaultValue<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">updatedSettingsUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">SettingsFeatureFlag</span><span class="token operator">&lt;</span><span class="token class-name">Bool</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">SettingsFeatureFlag</span><span class="token operator">&lt;</span><span class="token class-name">Bool</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"updated-settings-ui"</span></span><span class="token punctuation">,</span>
                                    defaultValue<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function-definition function">enabledCountries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">SettingsFeatureFlag</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">SettingsFeatureFlag</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"settings-content"</span></span><span class="token punctuation">,</span>
                                        defaultValue<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"es"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"en"</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>In order to do this, we just need to use dependency injection in our modules and make them depend on the <code>FeatureFlagManager</code> or <code>FeatureFlagUserAuthenticator</code> depending on their needs.</p><p>For example, the settings and feed modules only need to get variations, so they will only have to depend on <code>FeatureFlagManager</code> while our Login an Registration modules will need to only depend on <code>FeatureFlagUserAuthenticator</code>:</p><pre class=" language-swift"><code class="language-swift"><span class="token comment">// MARK: - SettingViewModel</span>

<span class="token keyword">class</span> <span class="token class-name">SettingsViewModel</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> featureFlagManager<span class="token punctuation">:</span> <span class="token class-name">FeatureFlagManager</span>

    <span class="token keyword">init</span><span class="token punctuation">(</span>featureFlagManager<span class="token punctuation">:</span> <span class="token class-name">FeatureFlagManager</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>featureFlagManager <span class="token operator">=</span> featureFlagManager
    <span class="token punctuation">}</span>

    <span class="token keyword">func</span> <span class="token function-definition function">getEnabledCountries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
        featureFlagManager
            <span class="token punctuation">.</span><span class="token function">variation</span><span class="token punctuation">(</span><span class="token keyword">for</span><span class="token punctuation">:</span> <span class="token class-name">SettingsFeatureFlag</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">enabledCountries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// MARK: - LoginViewModel</span>

<span class="token keyword">class</span> <span class="token class-name">LoginViewModel</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> featureFlagUserAuthenticator<span class="token punctuation">:</span> <span class="token class-name">FeatureFlagUserAuthenticator</span>

    <span class="token keyword">init</span><span class="token punctuation">(</span>featureFlagUserAuthenticator<span class="token punctuation">:</span> <span class="token class-name">FeatureFlagUserAuthenticator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>featureFlagUserAuthenticator <span class="token operator">=</span> featureFlagUserAuthenticator
    <span class="token punctuation">}</span>

    <span class="token keyword">func</span> <span class="token function-definition function">userDidLogIn</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> user<span class="token punctuation">:</span> <span class="token class-name">User</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        featureFlagUserAuthenticator<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">func</span> <span class="token function-definition function">userDidLogOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        featureFlagUserAuthenticator<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span><span class="token nil constant">nil</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="a-final-overview"><a href="#a-final-overview" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>A final overview</h2><p>Finally, I wanted to share the UML diagram where it all started ðŸ˜…. I find that diagrams are particularly useful when it comes to software design and architecture and let you see a lot clearly what you're trying to achieve.
<img src="/public/assets/posts/clean-architecture-a-feature-flag-provider/ab-testing-architecture.png" alt="Finished architecture UML diagram showing our Feature Flag system.">
As we can see in the image above, our modules don't know the concrete implementation of the providers, which can easily be replaced and our design is compliant with SOLID principles.</p><h2 id="next-steps"><a href="#next-steps" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Next Steps</h2><p>There is still some functionality missing such as tracking events as we need a way of letting our tracking provider know of how many conversions we're having on each particular feature flag. I will write a follow-up article but how would you go about implementing that? Where you would add the functionality?</p><p><strong>Happy Coding!</strong></p></article></div><footer class="astro-n31rkg6Y"><div class="social astro-n31rkg6Y"><a class="animated astro-n31rkg6Y" target="_blank" rel="noopener noreferrer" href="https://github.com/pol-piella"><img width="25px" height="25px" src="/assets/github.svg" class="astro-n31rkg6Y"></a><a class="animated astro-n31rkg6Y" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/pol-piella-81b846115/"><img width="25px" height="25px" src="/assets/linkedin.svg" class="astro-n31rkg6Y"></a><a class="animated astro-n31rkg6Y" target="_blank" rel="noopener noreferrer" href="https://twitter.com/polcodes"><img width="25px" height="25px" src="/assets/twitter.svg" class="astro-n31rkg6Y"></a></div></footer></body></html>