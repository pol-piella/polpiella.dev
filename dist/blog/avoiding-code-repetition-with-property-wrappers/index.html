<!DOCTYPE html><html><head><title>Using Property Wrappers to avoid code repetition</title><meta name="twitter:title" content="Using Property Wrappers to avoid code repetition"><meta name="twitter:description" content="Exploring how Property Wrappers can come in handy to avoid code repetition"><meta name="description" content="Exploring how Property Wrappers can come in handy to avoid code repetition"><meta name="twitter:site" content="@polcodes"><meta name="twitter:card" content="summary_large_image"><link rel="stylesheet" href="/_astro/common-DTqaC.css" type="text/css"><link rel="stylesheet" href="/style/global.css"><link rel="stylesheet" href="/style/blog-detail.css"></head><body><header class="astro-zvkshqHn"><a class="animated astro-zvkshqHn" href="/"><img src="/assets/logo.svg" class="astro-zvkshqHn"></a></header><div class="container astro-ocCYdhnH"><article class="content astro-ocCYdhnH"><header class="astro-ocCYdhnH"><h1 class="astro-ocCYdhnH">Using Property Wrappers to avoid code repetition</h1><div class="tags astro-OIpm9CS9"><div class="tag astro-OIpm9CS9">Swift</div></div><div class="metadata bottom-spaced astro-FzCPOh4H"><p class="astro-FzCPOh4H">Wed Aug 25 2021</p><p class="astro-FzCPOh4H">Â·</p><p class="astro-FzCPOh4H">ðŸ“– 4 minutes</p><div class="metadata astro-FzCPOh4H"><p class="astro-FzCPOh4H">Â·</p><a target="_blank" rel="noopener noreferrer" href="https://github.com/pol-piella/polpiella.dev/edit/main/_posts/avoiding-code-repetition-with-property-wrappers.md" class="astro-FzCPOh4H"><b class="astro-FzCPOh4H">Found a mistake? Edit on Github!</b></a></div></div></header><hr class="astro-ocCYdhnH"><p>The <code>DRY</code> principle is one of the fundamentals of software development and it is aimed at <strong>reducing the amount of duplication in our codebases</strong>. The accronym stands for <em>don't repeat yourself</em> and it encourages programmers to divide their code into smaller more reusable elements that can be shared across different parts of their applications.</p><p>While there are many approaches to reducing code duplication in Swift, in this article we're going to have a look at how <code>PropertyWrappers</code> can help us do this in a very simple manner.</p><p><code>PropertyWrapppers</code> provide us with a way of separating the property definition from the way we actually chose to store/retrieve the property. The way we achieve this in <code>Swift</code> is by making use of <code>getters</code> and <code>setters</code>, to override the way the OS will automatically store the variable in question. We can also use them to reuse property observers such as <code>didSet</code> and provide funcitonality that needs to be used across multiple variables.</p><p>To better illustrate this, let's picture an example where we have a feature flag that is being fetched from a local representation of a remote store. This store will be kept in sync periodically with its remote counterpart on a background thread so that all our calls to it will be synchronous.</p><p>Let's now consider a protocol, <code>FeatureFlagStore</code>, and a concrete implementation, <code>FirebaseRemoteConfig</code>, for the sake of simplicity. This protocol will consist of a single method and its only responsibility will be to grab the values from the store given a key and a default value to be returned should the lookup fail for whatever reason.</p><pre class=" language-swift"><code class="language-swift"><span class="token keyword">protocol</span> <span class="token class-name">FeatureFlagStore</span> <span class="token punctuation">{</span>
    <span class="token keyword">func</span> <span class="token function-definition function">retrieveFlag</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Codable</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">T</span>
<span class="token punctuation">}</span>
</code></pre><p>In order to make sure we are retrieving the most up-to-date values from our local store, the variable should go and fetch the correct value for the given key from the store every single time it is accessed. Let's have a look at how we would go about implementing by using a computed property first.</p><h2 id="computed-property"><a href="#computed-property" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Computed Property</h2><p>Using a computed property, as shown below, we can make sure that the flag to enable/disable the new flow that is currently on a phased rollout is always fetched from the store. We give it a key, a default value and we instantiate our store and there we have it, now our user will either navigate to the <code>NewVC</code> or <code>OldVC</code> based on the state of the feature flag.</p><pre class=" language-swift"><code class="language-swift"><span class="token keyword">class</span> <span class="token class-name">ViewController</span><span class="token punctuation">:</span> <span class="token class-name">UIViewController</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> store<span class="token punctuation">:</span> <span class="token class-name">FlagStore</span> <span class="token operator">=</span> <span class="token class-name">FirebaseRemoteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> isNewFlowEnabled<span class="token punctuation">:</span> <span class="token class-name">Bool</span> <span class="token punctuation">{</span>
        store<span class="token punctuation">.</span><span class="token function">retrieve</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"is-new-flow-enabled"</span></span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">func</span> <span class="token function-definition function">userDidNavigate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        navigationController<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>isNewFlowEnabled <span class="token operator">?</span> <span class="token class-name">NewVC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token class-name">OldVC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>While this approach is very valid, it will not scale very well. Every time we need to access a feature flag from any other part of the app we will need to repeat a lot of the functionality, leading to an increasing amount of code duplication. Worry not though! Swift has a lot of ways to prevent this from happening and this looks like a great example for a property wrapper!</p><h2 id="property-wrappper"><a href="#property-wrappper" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Property Wrappper</h2><p>Our property wrapper will be in charge of abstracting all the logic we had on our <code>ViewController</code> above into its own <code>struct</code>. It will need to define a <code>store</code>, a <code>key</code> and a <code>defaultValue</code>. Then, the only thing we need to do is define a <code>struct</code> decorated by <code>@propertyWrapper</code> and that implements a <code>wrappedValue</code> property that contains the logic we need for our <code>FeatureFlag</code> variables.</p><blockquote><p>Note that <code>PropertyWrappers</code> don't necessarily have to be <code>struct</code>s, they can also be <code>enum</code>s or <code>class</code>es. They must be decorated with <code>@propertyWrapper</code> and must implement a <code>wrappedValue</code> variable.</p></blockquote><pre class=" language-swift"><code class="language-swift"><span class="token attribute atrule">@propertyWrapper</span>
<span class="token keyword">struct</span> <span class="token class-name">FeatureFlag</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Decodable</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> store<span class="token punctuation">:</span> <span class="token class-name">FlagStore</span>
    <span class="token keyword">let</span> key<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">let</span> defaultValue<span class="token punctuation">:</span> <span class="token class-name">T</span>

    <span class="token keyword">init</span><span class="token punctuation">(</span>
        key<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
        defaultValue<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span>
        store<span class="token punctuation">:</span> <span class="token class-name">FlagStore</span> <span class="token operator">=</span> <span class="token class-name">FirebaseRemoteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key
        <span class="token keyword">self</span><span class="token punctuation">.</span>defaultValue <span class="token operator">=</span> defaultValue
        <span class="token keyword">self</span><span class="token punctuation">.</span>store <span class="token operator">=</span> store
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> wrappedValue<span class="token punctuation">:</span> <span class="token class-name">T</span> <span class="token punctuation">{</span>
        store<span class="token punctuation">.</span><span class="token function">retrieve</span><span class="token punctuation">(</span>defaultValue<span class="token punctuation">:</span> defaultValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>In the example above, we have made the <code>struct</code> generic (constraint to the <code>Decodable</code> protocol as most feature flag providers are only able to provide JSON values) and then we have made the <code>wrappedValue</code> get-only so that we ensure the most up-to-date value from the store is always returned.</p><p>Finally, let's have a look at how much code we have removed from our <code>ViewController</code> with our new Property Wrapper ðŸ¤©</p><pre class=" language-swift"><code class="language-swift"><span class="token keyword">class</span> <span class="token class-name">ViewController</span><span class="token punctuation">:</span> <span class="token class-name">UIViewController</span> <span class="token punctuation">{</span>
    <span class="token attribute atrule">@FeatureFlag</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"is-new-flow-enabled"</span></span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> isNewFlowEnabled<span class="token punctuation">:</span> <span class="token class-name">Bool</span>

    <span class="token keyword">func</span> <span class="token function-definition function">userDidNavigate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        navigationController<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>isNewFlowEnabled <span class="token operator">?</span> <span class="token class-name">NewVC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token class-name">OldVC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></article></div><footer class="astro-n31rkg6Y"><div class="social astro-n31rkg6Y"><a class="animated astro-n31rkg6Y" target="_blank" rel="noopener noreferrer" href="https://github.com/pol-piella"><img width="25px" height="25px" src="/assets/github.svg" class="astro-n31rkg6Y"></a><a class="animated astro-n31rkg6Y" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/pol-piella-81b846115/"><img width="25px" height="25px" src="/assets/linkedin.svg" class="astro-n31rkg6Y"></a><a class="animated astro-n31rkg6Y" target="_blank" rel="noopener noreferrer" href="https://twitter.com/polcodes"><img width="25px" height="25px" src="/assets/twitter.svg" class="astro-n31rkg6Y"></a></div></footer></body></html>